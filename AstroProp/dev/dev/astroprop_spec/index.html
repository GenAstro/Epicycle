<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>AstroProp Stopping Conditions – Spec (v0.1) · AstroProp.jl</title><meta name="title" content="AstroProp Stopping Conditions – Spec (v0.1) · AstroProp.jl"/><meta property="og:title" content="AstroProp Stopping Conditions – Spec (v0.1) · AstroProp.jl"/><meta property="twitter:title" content="AstroProp Stopping Conditions – Spec (v0.1) · AstroProp.jl"/><meta name="description" content="Documentation for AstroProp.jl."/><meta property="og:description" content="Documentation for AstroProp.jl."/><meta property="twitter:description" content="Documentation for AstroProp.jl."/><meta property="og:url" content="https://GenAstro.github.io/Epicycle/AstroProp/dev/astroprop_spec/"/><meta property="twitter:url" content="https://GenAstro.github.io/Epicycle/AstroProp/dev/astroprop_spec/"/><link rel="canonical" href="https://GenAstro.github.io/Epicycle/AstroProp/dev/astroprop_spec/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">AstroProp</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>AstroProp Stopping Conditions – Spec (v0.1)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>AstroProp Stopping Conditions – Spec (v0.1)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/GenAstro/Epicycle" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/GenAstro/Epicycle/blob/main/AstroProp/docs/src/dev/astroprop_spec.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="AstroProp-Stopping-Conditions-–-Spec-(v0.1)"><a class="docs-heading-anchor" href="#AstroProp-Stopping-Conditions-–-Spec-(v0.1)">AstroProp Stopping Conditions – Spec (v0.1)</a><a id="AstroProp-Stopping-Conditions-–-Spec-(v0.1)-1"></a><a class="docs-heading-anchor-permalink" href="#AstroProp-Stopping-Conditions-–-Spec-(v0.1)" title="Permalink"></a></h1><h2 id="1.-Overview-and-Scope-(What-are-we-building?)"><a class="docs-heading-anchor" href="#1.-Overview-and-Scope-(What-are-we-building?)">1. Overview and Scope (What are we building?)</a><a id="1.-Overview-and-Scope-(What-are-we-building?)-1"></a><a class="docs-heading-anchor-permalink" href="#1.-Overview-and-Scope-(What-are-we-building?)" title="Permalink"></a></h2><p><strong>Purpose:</strong></p><p>Stopping conditions enable termination of orbital propagation when specific events occur (state-based) or time thresholds are reached (time-based). They integrate with the propagation loop to detect events and halt integration at precise conditions.</p><p><strong>In-scope:</strong></p><ul><li>State-based stopping conditions (position, velocity, orbital elements)</li><li>Time-based stopping conditions (elapsed duration, absolute epoch)</li><li>Event detection and root-finding during propagation</li><li>Direction-aware crossing detection (increasing, decreasing, any)</li><li>Time scale handling (TT for Earth-centered, TDB for other centers)</li><li>Optimization-compatible duration variables (accept positive/negative values)</li></ul><p><strong>Out-of-scope:</strong></p><ul><li>Continuous event logging (only stop at first occurrence)</li><li>Multi-event chains (stop conditions are single-target)</li><li>Multiple time-based stopping conditions (only one time-based stop allowed per propagation)</li><li>Event sequencing logic (that&#39;s AstroSolve)</li><li>Custom event functions beyond StopAt pattern</li></ul><h2 id="2.-Requirements-(What-we-are-building.)"><a class="docs-heading-anchor" href="#2.-Requirements-(What-we-are-building.)">2. Requirements (What we are building.)</a><a id="2.-Requirements-(What-we-are-building.)-1"></a><a class="docs-heading-anchor-permalink" href="#2.-Requirements-(What-we-are-building.)" title="Permalink"></a></h2><p><strong>R1: State-Based Stopping</strong></p><ul><li>Must support stopping when any calc variable (position, velocity, orbital elements) crosses a target value</li><li>Must detect crossings with specified direction (increasing, decreasing, or any)</li><li>Must achieve target value within specified tolerance</li></ul><p><strong>R2: Time-Based Duration Stopping</strong></p><ul><li>Must support stopping after elapsed time duration (seconds, days)</li><li>Must accept positive durations (forward propagation) and negative durations (backward propagation)</li><li>Must infer propagation direction from duration sign when direction=:infer</li><li>Must work as optimization variables (no rejection of negative values)</li><li>Must use appropriate dynamical time scale (TT for Earth-centered, TDB otherwise)</li></ul><p><strong>R3: Absolute Time Stopping</strong></p><ul><li>Must support stopping at a specific absolute epoch (past or future)</li><li>Must handle time scale conversions automatically</li><li>Must infer propagation direction from time comparison when direction=:infer</li></ul><p><strong>R4: Type Safety</strong></p><ul><li>Must use AbstractCalcVariable type hierarchy for compile-time validation</li><li>Must reject invalid variable types at construction</li><li>Must provide clear error messages for type mismatches</li></ul><p><strong>R5: Integration with Propagation</strong></p><ul><li>Must work with OrdinaryDiffEq.jl callback system for state-based conditions</li><li>Must set integration time span directly for time-based conditions (no callbacks needed)</li><li>Must preserve propagation history when stopping</li></ul><h2 id="3.-Design-(How-we-are-building-it.)"><a class="docs-heading-anchor" href="#3.-Design-(How-we-are-building-it.)">3. Design (How we are building it.)</a><a id="3.-Design-(How-we-are-building-it.)-1"></a><a class="docs-heading-anchor-permalink" href="#3.-Design-(How-we-are-building-it.)" title="Permalink"></a></h2><h3 id="Core-Components"><a class="docs-heading-anchor" href="#Core-Components">Core Components</a><a id="Core-Components-1"></a><a class="docs-heading-anchor-permalink" href="#Core-Components" title="Permalink"></a></h3><p><strong>Types:</strong></p><ul><li><code>StopAt{S,V&lt;:AbstractCalcVariable,T}</code> - Generic stopping condition wrapper<ul><li>Fields: <code>subject</code>, <code>var</code>, <code>target</code>, <code>direction</code></li><li>Immutable struct holding stopping criteria</li><li>Type parameters ensure compile-time safety</li></ul></li><li><code>IntegratorTimeCalc &lt;: AbstractCalcVariable</code> - Abstract base for time-based stops<ul><li>Marker type distinguishing time-based from state-based</li><li>Handled specially by propagate!() (no callback, sets time span)</li><li><strong>Not general-purpose calcs</strong> - propagation-specific only</li></ul></li><li><code>PropDurationSeconds &lt;: IntegratorTimeCalc</code> - Elapsed time in seconds<ul><li>Positive value = forward propagation</li><li>Negative value = backward propagation</li><li>Zero not allowed</li></ul></li><li><code>PropDurationDays &lt;: IntegratorTimeCalc</code> - Elapsed time in days<ul><li>Same sign semantics as PropDurationSeconds</li><li>Converted to seconds internally (×86400)</li></ul></li></ul><p><strong>Functions:</strong></p><ul><li><code>StopAt(subject, var, target; direction=0)</code> - Main constructor<ul><li><code>direction</code>: -1 (decreasing), 0 (any), +1 (increasing)</li><li>Validates <code>var &lt;: AbstractCalcVariable</code></li></ul></li><li><code>StopAt(subject::Spacecraft, target_time::Time; direction=0)</code> - Convenience for absolute time<ul><li>Converts absolute time to elapsed seconds</li><li>Uses TT for Earth-centered, TDB otherwise (based on force model central body)</li><li>Supports past times with direction=:infer, errors with direction=:forward</li></ul></li><li><code>propagate!(propagator, spacecraft, stops...; direction=:forward, kwargs...)</code> - Integration driver<ul><li><code>direction</code> keyword: <code>:forward</code> (default), <code>:backward</code>, or <code>:infer</code> (analyze stop condition)</li><li><code>:infer</code> determines direction from stop condition (duration sign, time comparison)</li><li>Explicit <code>:forward</code>/<code>:backward</code> can validate agreement with stop condition</li></ul></li></ul><p><strong>Direction Inference:</strong></p><ul><li>For <code>PropDuration*</code>: Direction inferred from duration sign (positive=forward, negative=backward)</li><li>For <code>StopAt(Time)</code>: Direction inferred from time comparison (target&gt;current=forward, target&lt;current=backward)</li><li>For state-based: Direction defaults to <code>:forward</code> when <code>:infer</code> specified</li><li>Explicit <code>:forward</code>/<code>:backward</code> validates against inferred direction</li></ul><p><strong>Patterns:</strong></p><ul><li><strong>State-based</strong>: <code>StopAt(subject, CalcVariable(), target_value; direction=...)</code></li><li><strong>Duration-based</strong>: <code>StopAt(subject, PropDurationSeconds|Days(), duration)</code> with <code>direction=:infer</code></li><li><strong>Absolute time</strong>: <code>StopAt(subject, Time(...))</code> with <code>direction=:infer</code></li></ul><h3 id="Usage-Examples"><a class="docs-heading-anchor" href="#Usage-Examples">Usage Examples</a><a id="Usage-Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Usage-Examples" title="Permalink"></a></h3><p><strong>UC-1: State-Based Stopping (Addresses R1)</strong></p><p>Stop when spacecraft crosses specific position/velocity threshold.</p><pre><code class="language-julia hljs"># Stop at periapsis (r·v = 0, increasing)
stop_peri = StopAt(sat, PosDotVel(), 0.0; direction=+1)
propagate!(prop, sat, stop_peri)

# Stop at radius = 7000 km (any crossing)
stop_radius = StopAt(sat, PosMag(), 7000.0)
propagate!(prop, sat, stop_radius)

# Stop at x = 500 km (decreasing)
stop_x = StopAt(sat, PosX(), 500.0; direction=-1)
propagate!(prop, sat, stop_x)</code></pre><p><strong>Key Points:</strong></p><ul><li>Uses AstroCallbacks calc variables (PosDotVel, PosMag, PosX)</li><li>Direction control for precise event detection</li><li>Integrator finds exact crossing via root-finding</li></ul><hr/><p><strong>UC-2: Forward Duration Stopping (Addresses R2)</strong></p><p>Propagate forward for specified duration.</p><pre><code class="language-julia hljs"># Propagate for 3600 seconds (1 hour) - default :forward works
stop_1hr = StopAt(sat, PropDurationSeconds(), 3600.0)
propagate!(prop, sat, stop_1hr)  # direction=:forward (default)

# Propagate for 2.5 days
stop_days = StopAt(sat, PropDurationDays(), 2.5)
propagate!(prop, sat, stop_days)  # Default :forward matches positive duration

# Can explicitly validate if desired
propagate!(prop, sat, stop_days; direction=:forward)</code></pre><p><strong>Key Points:</strong></p><ul><li>Positive duration with default :forward direction works naturally</li><li>No need for :infer in common forward case</li><li>Uses TT for Earth-centered, TDB otherwise</li><li>No callback overhead (sets integration time span directly)</li></ul><hr/><p><strong>UC-3: Backward Duration Stopping (Addresses R2)</strong></p><p>Propagate backward for specified duration.</p><pre><code class="language-julia hljs"># Propagate backward for 7200 seconds (2 hours) - use :infer or :backward
stop_back = StopAt(sat, PropDurationSeconds(), -7200.0)
propagate!(prop, sat, stop_back; direction=:infer)  # Infers :backward from negative
# OR
propagate!(prop, sat, stop_back; direction=:backward)  # Explicit backward

# Propagate backward for 1.5 days
stop_back_days = StopAt(sat, PropDurationDays(), -1.5)
propagate!(prop, sat, stop_back_days; direction=:infer)  # Infers from sign</code></pre><p><strong>Key Points:</strong></p><ul><li>Negative duration requires explicit direction (default :forward would conflict)</li><li>Use <code>direction=:infer</code> to infer from sign automatically</li><li>Or use explicit <code>direction=:backward</code></li><li>Spacecraft time decreases after propagation</li></ul><hr/><p><strong>UC-4: Duration in Optimization (Addresses R2)</strong></p><p>Use duration as optimization variable.</p><pre><code class="language-julia hljs"># Duration is optimizable parameter
duration_calc = VariableCalc(1.5)  # Initial guess: 1.5 days
var = SolverVariable(calc=duration_calc, lower=-10.0, upper=10.0)

# In objective/constraint function - use :infer for automatic direction
function propagate_and_evaluate(duration_calc)
    dur_val = get_calc(duration_calc)
    stop = StopAt(sat, PropDurationDays(), dur_val)
    
    # direction=:infer handles positive or negative duration automatically
    propagate!(prop, sat, stop; direction=:infer)
    
    # Evaluate cost/constraint...
end</code></pre><p><strong>Key Points:</strong></p><ul><li>Optimizer can explore negative durations (backward propagation)</li><li><code>direction=:infer</code> automatically handles sign changes (one line, no if-test!)</li><li>Much cleaner than manual direction checking</li><li>No error thrown for negative values</li></ul><hr/><p><strong>UC-5: Absolute Time Stopping (Addresses R3)</strong></p><p>Stop at specific epoch (past or future).</p><pre><code class="language-julia hljs"># Target time 1 day in the future - default :forward works
target_future = Time(&quot;2015-09-22T12:00:00&quot;, UTC(), ISOT())
propagate!(prop, sat, StopAt(sat, target_future))  # direction=:forward (default)

# Target time in the past - use :infer or explicit :backward
target_past = Time(&quot;2015-09-20T12:00:00&quot;, UTC(), ISOT())
propagate!(prop, sat, StopAt(sat, target_past); direction=:infer)  # Infers :backward
# OR
propagate!(prop, sat, StopAt(sat, target_past); direction=:backward)  # Explicit

# Internally converts to elapsed seconds in correct time scale
# For Earth: uses TT
# For Mars/others: uses TDB</code></pre><p><strong>Key Points:</strong></p><ul><li>Time scale conversion automatic (TT for Earth, TDB for others based on force model central body)</li><li>Future times work with default :forward</li><li>Past times work with :infer (infers :backward from comparison) or explicit :backward</li><li>Past times error with default :forward (conflict detection)</li><li>Direction inferred from time comparison when :infer used</li><li>Implemented as PropDurationSeconds internally with appropriate sign</li></ul><hr/><p><strong>UC-6: Error Cases (Addresses R4)</strong></p><p>Invalid configurations are rejected.</p><pre><code class="language-julia hljs"># Error: invalid direction value
stop = StopAt(sat, PropDurationDays(), 1.5)
propagate!(prop, sat, stop; direction=:invalid)
# ERROR: Invalid direction :invalid, must be :infer, :forward, or :backward

# Error: explicit direction conflicts with inferred
stop = StopAt(sat, PropDurationDays(), -1.5)  # Negative → infers :backward
propagate!(prop, sat, stop; direction=:forward)  # But user says :forward
# ERROR: Inferred direction is :backward (negative duration) but explicit direction is :forward

# Error: zero duration
stop = StopAt(sat, PropDurationDays(), 0.0)
propagate!(prop, sat, stop)
# ERROR: Duration must be non-zero

# Error: multiple time-based stops
stop1 = StopAt(sat, PropDurationSeconds(), 3600.0)
stop2 = StopAt(sat, PropDurationDays(), 1.0)
propagate!(prop, sat, stop1, stop2)
# ERROR: Multiple time-based stopping conditions not allowed

# Error: positive duration with :backward
stop = StopAt(sat, PropDurationDays(), 1.5)  # Positive → infers :forward
propagate!(prop, sat, stop; direction=:backward)  # But user says :backward
# ERROR: Duration is positive (forward) but explicit direction is :backward</code></pre><p><strong>Key Points:</strong></p><ul><li>Explicit direction validated against inferred direction (both positive→:backward and negative→:forward conflict)</li><li>Zero duration rejected</li><li>Multiple time-based stops rejected (ambiguous which to use)</li><li>Clear error messages with context</li></ul><hr/><h3 id="Design-Decisions-and-Rationale"><a class="docs-heading-anchor" href="#Design-Decisions-and-Rationale">Design Decisions and Rationale</a><a id="Design-Decisions-and-Rationale-1"></a><a class="docs-heading-anchor-permalink" href="#Design-Decisions-and-Rationale" title="Permalink"></a></h3><p><strong>Why PropDuration* instead of general elapsed time calcs?</strong></p><ul><li>Problem: Elapsed time requires anchor point, unclear who owns it</li><li>Tried: RelativeTimeCalc(sat, ElapsedDays()) with anchor-at-construction</li><li>Issue: Inline construction in loops creates new anchor each iteration</li><li>Solution: PropDuration* are propagation-specific, anchor managed by propagate!()</li><li>Future: May add general RelativeTimeCalc later with explicit anchor management</li></ul><p><strong>Why duration sign encodes direction with :infer?</strong></p><ul><li>Alternative 1: Always positive, direction keyword required → errors in optimization</li><li>Alternative 2: Signed duration, manual direction keyword → boilerplate in optimization</li><li>Solution: Signed duration + direction=:infer (default) infers from sign</li><li>Benefits: Clean optimization (no if-test), explicit override available, works for absolute time too</li><li>Trade-off: Slightly &quot;magical&quot; but ergonomics win justifies it</li></ul><p><strong>Why separate StopAt(Time) constructor?</strong></p><ul><li>Common use case: &quot;propagate to epoch&quot;</li><li>Convenience: Handles time scale conversion automatically</li><li>Implementation: Converts to PropDurationSeconds internally</li><li>Alternative considered: User manually computes elapsed time - rejected for ergonomics</li></ul><p><strong>Why IntegratorTimeCalc subtypes instead of TimeCalc?</strong></p><ul><li>TimeCalc is for general time queries (scale conversions, formatting)</li><li>PropDuration* are propagation-specific, not general-purpose</li><li>Inheritance from AbstractCalcVariable for type safety in StopAt</li><li>No make_calc() implementations (can&#39;t create OrbitCalc with these)</li></ul><p><strong>Why TT for Earth, TDB for others?</strong></p><ul><li>Earth-based missions: TT (Terrestrial Time) is standard dynamical time</li><li>Solar system missions: TDB (Barycentric Dynamical Time) is standard</li><li>Consistency: Matches how integrator time is managed internally</li><li>Detection: Based on force model central body (forces.center)</li></ul><h3 id="Conventions-and-Constraints"><a class="docs-heading-anchor" href="#Conventions-and-Constraints">Conventions &amp; Constraints</a><a id="Conventions-and-Constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Conventions-and-Constraints" title="Permalink"></a></h3><p><strong>Naming:</strong></p><ul><li>PropDuration* prefix signals propagation-specific scope</li><li>Leaves ElapsedDays/Seconds/Hours available for future general calcs</li><li>StopAt named for action (stop at event/time)</li></ul><p><strong>Numeric Types:</strong></p><ul><li>Duration: Float64 (can be negative for backward)</li><li>Target values: Float64 or Vector{Float64} (matches calc output)</li><li>Time: Julian Date (Float64) internally</li><li>Tolerance: Integrator-dependent (typically 1e-9 relative)</li></ul><p><strong>Mutability:</strong></p><ul><li>StopAt struct is immutable (just configuration)</li><li>Spacecraft is mutated in-place by propagate!()</li><li>Propagation history updated during integration</li></ul><p><strong>Error Handling:</strong></p><ul><li>Throw errors for invalid types at construction</li><li>Throw errors for past target times</li><li>Throw errors for direction keyword conflicts</li><li>Validation before propagation starts (fail fast)</li><li>Clear error messages: &quot;Duration is negative (-1.5) but direction is :forward&quot;</li></ul><p><strong>Duration Sign Semantics:</strong></p><ul><li>Positive: Forward propagation (time increases)</li><li>Negative: Backward propagation (time decreases)</li><li>Zero: Not allowed (would cause division by zero in validation)</li><li>Validation: If direction keyword provided, must match sign</li></ul><p><strong>Direction Keyword:</strong></p><ul><li>Default: <code>:forward</code> (most common case - forward propagation)</li><li><code>:infer</code>: Opt-in analysis of stop condition to determine direction<ul><li>Time-based (PropDuration*): Inferred from duration sign (positive=forward, negative=backward)</li><li>Time-based (absolute): Inferred from time comparison (target&gt;current=forward, target&lt;current=backward)</li><li>State-based: Defaults to <code>:forward</code> when <code>:infer</code> specified</li></ul></li><li>Explicit <code>:backward</code>: Required for backward propagation with default behavior</li><li>Explicit <code>:forward</code>/<code>:backward</code> can validate against inferred direction when using <code>:infer</code></li><li>Values: <code>:forward</code> (default), <code>:backward</code>, <code>:infer</code></li></ul><h2 id="4.-Package-Interactions-(Where-it-fits)"><a class="docs-heading-anchor" href="#4.-Package-Interactions-(Where-it-fits)">4. Package Interactions (Where it fits)</a><a id="4.-Package-Interactions-(Where-it-fits)-1"></a><a class="docs-heading-anchor-permalink" href="#4.-Package-Interactions-(Where-it-fits)" title="Permalink"></a></h2><p><strong>Package Dependencies:</strong></p><ul><li>AstroCallbacks - OrbitCalc, AbstractCalcVariable hierarchy</li><li>AstroEpochs - Time type, scale conversions</li><li>AstroModels - Spacecraft type</li><li>OrdinaryDiffEq - Integration and callback system</li></ul><p><strong>Used by:</strong></p><ul><li>User propagation scripts</li><li>AstroSolve - optimization with time-based variables</li><li>Example/tutorial code</li></ul><p><strong>Example Interactions:</strong></p><pre><code class="language-julia hljs"># AstroCallbacks provides calc variables
using AstroCallbacks: PosMag, PosDotVel, PosX

# AstroProp provides StopAt and propagate
stop_condition = StopAt(sat, PosMag(), 7000.0)
propagate!(prop, sat, stop_condition)

# AstroSolve uses duration as optimization variable
duration_var = VariableCalc(2.0)
solver_var = SolverVariable(calc=duration_var, lower=-5.0, upper=5.0)</code></pre><h2 id="5.-Testing-(How-we-verify-it)"><a class="docs-heading-anchor" href="#5.-Testing-(How-we-verify-it)">5. Testing (How we verify it)</a><a id="5.-Testing-(How-we-verify-it)-1"></a><a class="docs-heading-anchor-permalink" href="#5.-Testing-(How-we-verify-it)" title="Permalink"></a></h2><h3 id="Test-categories:"><a class="docs-heading-anchor" href="#Test-categories:">Test categories:</a><a id="Test-categories:-1"></a><a class="docs-heading-anchor-permalink" href="#Test-categories:" title="Permalink"></a></h3><p><strong>Input Validation</strong></p><ul><li>Invalid variable types rejected at StopAt construction</li><li>Past target time throws error</li><li>Direction-duration sign conflicts throw error</li><li>Zero duration throws error</li><li>Clear error messages for all validation failures</li></ul><p><strong>Correctness</strong></p><ul><li>State-based stops achieve target within tolerance</li><li>Direction constraints honored (increasing/decreasing crossings)</li><li>Duration-based stops advance time by correct amount</li><li>Absolute time stops arrive at target epoch</li><li>Backward propagation decreases time correctly</li></ul><p><strong>Numeric Accuracy</strong></p><ul><li>Duration-based: elapsed time matches target ±1e-6 seconds</li><li>State-based: target value achieved ±1e-3 km or ±1e-6 rad</li><li>Time scale conversions accurate ±1e-9 days</li><li>Reference: Analytical solutions, published ephemerides</li></ul><p><strong>Integration</strong></p><ul><li>Works with OrbitCalc variables from AstroCallbacks</li><li>Time conversions via AstroEpochs</li><li>Propagation updates Spacecraft state correctly</li><li>History segments preserved after stopping</li></ul><p><strong>Regression</strong></p><ul><li>Duration sign semantics (positive=forward, negative=backward)</li><li>Direction validation catches conflicts</li><li>TT/TDB selection based on central body</li><li>StopAt(Time) past-time detection</li></ul><h3 id="Test-Coverage:"><a class="docs-heading-anchor" href="#Test-Coverage:">Test Coverage:</a><a id="Test-Coverage:-1"></a><a class="docs-heading-anchor-permalink" href="#Test-Coverage:" title="Permalink"></a></h3><p><strong>PropDuration Tests:</strong></p><ul><li>Forward propagation (seconds, days)</li><li>Backward propagation with :infer (seconds, days)</li><li>Backward propagation with explicit :backward</li><li>Zero duration error</li><li>Direction conflict validation (negative+:forward, positive+:backward)</li><li>Multiple time-based stops error</li></ul><p><strong>Absolute Time Tests:</strong></p><ul><li>Future time stop</li><li>Past time error</li><li>Time scale conversion (UTC→TT, various scales)</li></ul><p><strong>Time Scale Tests:</strong></p><ul><li>Earth-centered uses TT</li><li>Mars-centered uses TDB</li><li>Other bodies use TDB</li></ul><p><strong>State-Based Tests:</strong></p><ul><li>Radius crossing (any direction)</li><li>Position component (increasing/decreasing)</li><li>Orbital element crossings</li></ul><h3 id="Notes:"><a class="docs-heading-anchor" href="#Notes:">Notes:</a><a id="Notes:-1"></a><a class="docs-heading-anchor-permalink" href="#Notes:" title="Permalink"></a></h3><ul><li>Tolerances reflect integrator accuracy, not event detection</li><li>Event detection accuracy depends on callback root-finding</li><li>PropDuration* are propagation-specific, not tested as general calcs</li></ul></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.17.0 on <span class="colophon-date" title="Saturday 21 February 2026 15:39">Saturday 21 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
